{% comment %}
  Reusable custom dropdown for product metaobjects.
  Accepts:
  - product: {Object}
  - section: {Object}
  - metafield_key: {String} e.g. "custom.product_option_materials"
  - label_text: {String} Optional – label above the dropdown
  - property_name: {String} Optional – line item property key (default: label_text or 'Custom Option')

  Usage:
  {% render 'pak-custom-meta-dropdown',
  product: product,
  section: section,
  metafield_key: 'custom.product_option_materials',
  label_text: 'Preferred Material',
  property_name: 'Material' %}
{% endcomment %}

<link
  rel="stylesheet"
  href="{{ 'pak-custom-dropdown.css' | asset_url }}"
  media="print"
  onload="this.media='all'">
<script src="{{ 'pak-custom-dowpdown.js' | asset_url }}" defer></script>

{% assign label = label_text | default: 'Custom Option' %}
{% assign prop_name = property_name | default: label %}

<div class="field custom__field" data-section-id="{{ section.id }}">
  <label class="field__label">{{ label }}</label>

  {% assign key_parts = metafield_key | split: '.' %}
  {% assign namespace = key_parts[0] %}
  {% assign key = key_parts[1] %}
  {% assign items = product.metafields[namespace][key].value %}

    <div class="pak-custom-dropdown" data-dropdown>
    <button
      type="button"
      class="field__input dropdown-toggle"
      aria-haspopup="listbox"
      aria-expanded="false">
      <span class="dropdown-label">Need Consultation</span>
      {% render 'icon-caret' %}
    </button>

    <ul
      class="dropdown-options"
      role="listbox"
      hidden>
      <!-- Static default option -->
      <li
        class="dropdown-option"
        role="option"
        tabindex="0"
        data-value="Need Consultation">
        <span class="thumb">
          <span class="placeholder"></span>
        </span>
        <span class="label">Need Consultation</span>
      </li>

      <!-- Dynamic options from metafield -->
      {% for item in items %}
        {% assign option_label = item.display_name | default: item.name %}
        <li
          class="dropdown-option"
          role="option"
          tabindex="0"
          data-value="{{ option_label | escape }}">
          <span class="thumb">
            {% if item.image %}
              <img
                src="{{ item.image | image_url: width: 64 }}"
                alt="{{ option_label }}"
                width="64"
                height="64" />
            {% else %}
              <span class="placeholder"></span>
            {% endif %}
          </span>
          <span class="label">{{ option_label }}</span>
        </li>
      {% endfor %}
    </ul>

    <!-- Line item property for submission -->
    <input
      type="hidden"
      name="properties[{{ prop_name }}]"
      value="Need Consultation" />
  </div>
</div>